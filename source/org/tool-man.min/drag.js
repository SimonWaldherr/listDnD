ToolMan._dragFactory={createSimpleGroup:function(a,b){b=b?b:a;var c=this.createGroup(a);c.setHandle(b);c.transparentDrag();c.onTopWhileDragging();return c},createGroup:function(b){var c=new _ToolManDragGroup(this,b);var a=ToolMan.css().readStyle(b,"position");if(a=="static"){b.style.position="relative"}else{if(a=="absolute"){ToolMan.coordinates().topLeftOffset(b).reposition(b)}}c.register("draginit",this._showDragEventStatus);c.register("dragmove",this._showDragEventStatus);c.register("dragend",this._showDragEventStatus);return c},_showDragEventStatus:function(a){window.status=a.toString()},constraints:function(){return this._constraintFactory},_createEvent:function(a,b,c){return new _ToolManDragEvent(a,b,c)}};function _ToolManDragGroup(a,b){this.factory=a;this.element=b;this._handle=null;this._thresholdDistance=0;this._transforms=new Array();this._listeners=new Array();this._listeners.draginit=new Array();this._listeners.dragstart=new Array();this._listeners.dragmove=new Array();this._listeners.dragend=new Array()}_ToolManDragGroup.prototype={setHandle:function(b){var a=ToolMan.events();b.toolManDragGroup=this;a.register(b,"mousedown",this._dragInit);b.onmousedown=function(){return false};if(this.element!=b){a.unregister(this.element,"mousedown",this._dragInit)}},register:function(a,b){this._listeners[a].push(b)},addTransform:function(a){this._transforms.push(a)},verticalOnly:function(){this.addTransform(this.factory.constraints().vertical())},horizontalOnly:function(){this.addTransform(this.factory.constraints().horizontal())},setThreshold:function(a){this._thresholdDistance=a},transparentDrag:function(a){var a=typeof(a)!="undefined"?a:0.75;var b=ToolMan.css().readStyle(this.element,"opacity");this.register("dragstart",function(d){var c=d.group.element;c.style.opacity=a;c.style.filter="alpha(opacity="+(a*100)+")"});this.register("dragend",function(d){var c=d.group.element;c.style.opacity=b;c.style.filter="alpha(opacity=100)"})},onTopWhileDragging:function(b){var b=typeof(b)!="undefined"?b:100000;var a=ToolMan.css().readStyle(this.element,"z-index");this.register("dragstart",function(c){c.group.element.style.zIndex=b});this.register("dragend",function(c){c.group.element.style.zIndex=a})},_dragInit:function(a){a=ToolMan.events().fix(a);var c=document.toolManDragGroup=this.toolManDragGroup;var b=c.factory._createEvent("draginit",a,c);c._isThresholdExceeded=false;c._initialMouseOffset=b.mouseOffset;c._grabOffset=b.mouseOffset.minus(b.topLeftOffset);ToolMan.events().register(document,"mousemove",c._drag);document.onmousemove=function(){return false};ToolMan.events().register(document,"mouseup",c._dragEnd);c._notifyListeners(b)},_drag:function(b){b=ToolMan.events().fix(b);var j=ToolMan.coordinates();var k=this.toolManDragGroup;if(!k){return}var h=k.factory._createEvent("dragmove",b,k);var g=h.mouseOffset.minus(k._grabOffset);if(!k._isThresholdExceeded){var a=h.mouseOffset.distance(k._initialMouseOffset);if(a<k._thresholdDistance){return}k._isThresholdExceeded=true;k._notifyListeners(k.factory._createEvent("dragstart",b,k))}for(i in k._transforms){var d=k._transforms[i];g=d(g,h)}var f=g.minus(h.topLeftOffset);var e=h.topLeftPosition.plus(f);e.reposition(k.element);h.transformedMouseOffset=g.plus(k._grabOffset);k._notifyListeners(h);var c=g.minus(j.topLeftOffset(k.element));if(c.x!=0||c.y!=0){j.topLeftPosition(k.element).plus(c).reposition(k.element)}},_dragEnd:function(a){a=ToolMan.events().fix(a);var c=this.toolManDragGroup;var b=c.factory._createEvent("dragend",a,c);c._notifyListeners(b);this.toolManDragGroup=null;ToolMan.events().unregister(document,"mousemove",c._drag);document.onmousemove=null;ToolMan.events().unregister(document,"mouseup",c._dragEnd)},_notifyListeners:function(b){var a=this._listeners[b.type];for(i in a){a[i](b)}}};function _ToolManDragEvent(a,b,c){this.type=a;this.group=c;this.mousePosition=ToolMan.coordinates().mousePosition(b);this.mouseOffset=ToolMan.coordinates().mouseOffset(b);this.transformedMouseOffset=this.mouseOffset;this.topLeftPosition=ToolMan.coordinates().topLeftPosition(c.element);this.topLeftOffset=ToolMan.coordinates().topLeftOffset(c.element)}_ToolManDragEvent.prototype={toString:function(){return"mouse: "+this.mousePosition+this.mouseOffset+"    xmouse: "+this.transformedMouseOffset+"    left,top: "+this.topLeftPosition+this.topLeftOffset}};ToolMan._dragFactory._constraintFactory={vertical:function(){return function(c,b){var a=b.topLeftOffset.x;return c.x!=a?c.factory.create(a,c.y):c}},horizontal:function(){return function(c,a){var b=a.topLeftOffset.y;return c.y!=b?c.factory.create(c.x,b):c}}};